<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href = "style.css"></link>
<script type="text/javascript" src="funcs.js"></script>

{% import 'macros.html' as m %}

<html>
<script>
    {{ m.lcdFmtCheatSheet(values) }}

    const delay = s => new Promise(res => setTimeout(res, 1000*s));

    function connectSocket(fullUrl, element, button){
        var sock = new WebSocket(fullUrl)

        sock.onmessage = (event) => {
            message = event.data
            if(message === undefined){
                window.alert(`Dashboard Update Error \nStatus: ${response.status} \n${response.statusText}`);
                return;
            }
            console.log(message)
            element.textContent = message;
        }
        sock.onopen = () => {
            console.log('Socket Connected');
        }
        button.onclick = () => {
            element.textContent = "";
            sock.close()
            connectSocket(fullUrl, element, button)
        };

    }

    function initDashboardElement(name, url){
        const fullUrl = `ws://${window.location.host}${url}`;
        const element = document.getElementById(`dashboard-${name}`);
        const button = document.getElementById(`dashboardButton-${name}`);
        connectSocket(fullUrl, element, button)
    }

    const days = ['Sun', 'Mon', 'Tues', 'Wed', 'Thurs', 'Fri', 'Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','June','July','Aug','Sept','Oct','Nov','Dec']

    function getTime(){
        var dt = new Date();
        const dayName = days[dt.getDay()];
        const monthName = months[dt.getMonth()];
        //const year = dt.getFullYear();
        const date = dt.getDate();

        const hours = dt.getHours()
        const hoursStr   = String(hours%12).padStart(2,'0');
        const minutesStr = String(dt.getMinutes()).padStart(2,'0');
        const secondsStr = String(dt.getSeconds()).padStart(2,'0');
        const ampm    = Math.floor(hours/12) == 0 ? 'AM' : 'PM';

        const time    = `${hoursStr}:${minutesStr}:${secondsStr} ${ampm}`

        return `${dayName}, ${monthName} ${date} \n${time}`;
    }

    async function clock(name){
        const element = document.getElementById(`dashboard-${name}`);
        const button = document.getElementById(`dashboardButton-${name}`);

        button.onclick = () => {
            element.textContent=getTime();
        };

        var cond = true;
        while(cond){
            element.textContent=getTime();
            await delay(1);
        }
    }

    async function editLCD(){
        const element = document.getElementById(`dashboard-LCD`);
        const text = element.textContent;
        const lines = text.split('\n')
        oldLine1 = lines.length > 0 ? lines[0] : ""
        oldLine2 = lines.length > 0 ? lines[1] : ""

        const line1 = window.prompt("LCD Line 1:", oldLine1);
        if(line1 === null){
            return;
        }
        const line2 = window.prompt("LCD Line 2:", oldLine2);

        var data = {'line1': line1};
        var newText = line1;
        if(line2 !== null){
            data['line2'] = line2;
            newText += '\n' + line2;
        }

        ok = await sendData('api/dashboard/lcd', data, 'POST');
        if(ok){
            element.textContent = newText;
        }
    }

    function initLCD(){
        initDashboardElement('LCD', '/api/data/lcd')
    }

    function toggleLCDBacklight(){
        fetch('api/dashboard/lcd/toggle', {method: "POST"})
        .then((response) => {
            if(!response.ok){
                window.alert(`Dashboard LCD ToggleBacklight Error \nStatus: ${response.status} \n${response.statusText}`);
                return;
            }
        })
    }

    window.onload = () => {
        clock('clock');
        initLCD()
        {% for element in dashboardElements %}
            initDashboardElement("{{ element['name'] }}", "{{ element['url'] }}")
            //pollDashboardElement("{{ element['name'] }}", "{{ element['url'] }}", {{ element['pollingPeriod'] }});
        {% endfor %}
    }
</script>

<body>
    <div class="topnav">
        <a class="active" href="/dashboard">Dashboard</a>
        <a href="/remote">Remote</a>
        <a href="/schedule">Schedule</a>
        <a href="/trigger">Trigger</a>
    </div> 

    <div class="dashboardList">
        <div>
            <button id="dashboardButton-clock" class="orangeButton" onclick="">Clock</button>
            <p id="dashboard-clock"></p>
        </div>
        {% for element in dashboardElements %}
            {% set name          = element['name'] %}
            {% set color         = element['color'] %}
            {% set url           = element['url'] %}
            <div>
                <button class="{{ color }}Button" id="dashboardButton-{{ name }}">{{ name }}</button>
                <p id="dashboard-{{ name }}"></p>
            </div>
        {% endfor %}
        <div>
            <button id="dashboardButton-LCD" class="purpleButton" onclick="getLCD()">LCD</button>
            <button id="dashboardButton-LCD-Edit" class="purpleButton" onclick="editLCD()">Edit</button>
            <button class="purpleButton" onclick="lcdFmtCheatSheet()">?</button>
            <button id="dashboardButton-LCD-Backlight" class="purpleButton" onclick="toggleLCDBacklight()">Light</button>
            <p id="dashboard-LCD"></p>
        </div>
  </body>
</html>
