<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href = "style.css"></link>
<script type="text/javascript" src="funcs.js"></script>

<html>
<script>
    const weekdays = ["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]

    function jobEnable(jobId, enable){
        var data = {'id': jobId, 'enable': enable};
        sendData('api/schedule/jobs/enable', data, 'POST', reload=true);
    }
    function jobDelete(jobId){
        var data = {'id': jobId};
        sendData('api/schedule/jobs', data, 'DELETE', reload=true);
    }

    function submitJobHandler(event){
        event.preventDefault();
        let form = event.currentTarget;
        var data = formToObject(form);

        if(data.do = "press"){
            data.do = {type:"press", data:{channel: Number(data.pressChannel), value: Boolean(data.pressValue)}};
            delete data.pressChannel;
            delete data.pressValue;
        }
        else{
            window.alert(`Error: invalid job type: ${data.do}`);
            return;
        }

        // every is not compatible with days of the week
        if(weekdays.indexOf(data.unit)!== -1){
            delete data.every;
        }
        if(data.unit === "week"){
            delete data.atHours;
            delete data.atMinutes;
            delete data.atSeconds;
        }

        data = Object.fromEntries(Object.entries(data).filter(([_, v]) => v !== null && v !== undefined && v!== ""));

        if ('atHours' in data){data.atHours = Number(data.atHours);}
        if ('atMinutes' in data){data.atMinutes = Number(data.atMinutes);}
        if ('atSeconds' in data){data.atSeconds = Number(data.atSeconds);}
        if ('every' in data){data.every = Number(data.every);}

        sendData('api/schedule', data, 'POST', reload=true);
    }

    function hideUnhideJobForms(dropDown){
        // iterate over options in the drop down
        Array.from(dropDown.options).forEach((dropDownOption) => {
            // get all elements which match that option
            const optionElements = document.querySelectorAll(`[id^='${dropDownOption.value}']`);

            // see if they match the current value
            if (dropDown.value === dropDownOption.value) {
                // if so, display them
                optionElements.forEach((element) => {element.style.display = "block"});
            } else {
                // else hide them
                optionElements.forEach((element) => {element.style.display = "none"});
            }
        })
    }

    function hideUnhideEvery(dropDown){
        const everyText = document.querySelector(`[id=everyText]`);
        const everyInput = document.querySelector(`[id=everyInput]`);

        everyText.style.display = "block";
        everyInput.style.display = "inline";

        // if dropdown value is one of the days of the week
        if (weekdays.indexOf(dropDown.value) !== -1) {
            everyText.style.display = "none";
            everyInput.style.display = "none";
            return;
        } 
    }

    function hideUnhideAtTimes(dropDown){
        const atText = document.querySelector(`[id=atText]`);
        const atSeconds = document.querySelector(`[id=atSeconds]`);
        const atMinutes = document.querySelector(`[id=atMinutes]`);
        const atHours = document.querySelector(`[id=atHours]`);

        atText.style.display = "block";
        atSeconds.style.display = "inline";
        atMinutes.style.display = "inline"
        atHours.style.display = "inline";

        if (dropDown.value === "second" || dropDown.value == "week") {
            atText.style.display = "none";
            atSeconds.style.display = "none";
            atMinutes.style.display = "none"
            atHours.style.display = "none";
            return;
        } 
        if (dropDown.value == "minute"){
            atMinutes.style.display = "none"
            atHours.style.display = "none";
            return;
        }
        if (dropDown.value == "hour"){
            atHours.style.display = "none";
            return;
        }
    }

    function updateJobName(jobId, jobName){
        const newName = window.prompt("Edit Name:", jobName);

        if (newName == null || newName == undefined){
            return;
        }

        if(newName.length > 20){
            window.alert(`Name Too Long:\n  max length: 20 \n  current length: ${newName.length}`);
            updateJobName(jobId, newName);
            return;
        }

        var data = {'id': jobId, 'name': newName};

        sendData('api/schedule/jobs', data, 'PATCH', reload=true);
    }

    window.onload = () => {
        document.getElementById('jobForm').addEventListener('submit', submitJobHandler);

        // hide form fields for jobs unless they are selected in do dropdown
        hideUnhideAtTimes(document.querySelector('#unit'));
        document.querySelector('#unit').addEventListener("change", function(dropDown) {hideUnhideAtTimes(dropDown.target)});

        hideUnhideJobForms(document.querySelector('#do'));
        document.querySelector('#do').addEventListener("change", function(dropDown) {hideUnhideJobForms(dropDown.target)});

        hideUnhideEvery(document.querySelector('#unit'));
        document.querySelector('#unit').addEventListener("change", function(dropDown) {hideUnhideEvery(dropDown.target)});
    }
    
</script>


<body>
    <div class="topnav">
        <a href="/dashboard">Dashboard</a>
        <a href="/remote">Remote</a>
        <a class="active" href="/schedule">Schedule</a>
    </div> 

    <h3>Current Schedule:</h3>
        <ul class="schedule">
            {% if jobs|length == 0 %}
                <p>Schedule Empty</p>
            {% endif %}

            {% for job in jobs %}
                {% set jobId = job['id'] %}
                {% set jobName = job['name'] %}
                <li>
                    <div class="job">
                        <button class="redButton", onclick = "jobDelete('{{ jobId }}')"">X</button>

                        <button class="blueButton" onclick="updateJobName( '{{ jobId }}', '{{ jobName }}' )">{{ jobName }}</button>

                        {% if job['enabled'] %}
                            <button class="greenButton", onclick = "jobEnable('{{ jobId }}', false )"">active</button>
                        {% else %}
                            <button class="redButton", onclick = "jobEnable('{{ jobId }}', true )"">inactive</button>
                        {% endif %}


                        <div class="jobText">
                            <span class="nobr">every </span>
                            {% if 'every' in job %}
                                <span class="nobr">{{ job['every'] }} {{ job['unit'] }}</span>
                            {% else %}
                                <span class="nobr"> {{ job['unit'] }} </span>
                            {% endif %}

                            {% if 'at' in job %}
                                <span class="nobr">at {{ job['at'] }} </span>
                            {% endif %}


                            {% set do = job['do'] %}
                            {% set type = do['type'] %}
                            {% set data = do['data'] %}

                            <br/>
                            <span class="nobr">â†’ </span>
                            {% if type == "press" %}
                            <span class="nobr">switch channel:{{ data['channel'] }} {{'on' if data['value'] else 'off' }}</span>
                            {% else %}
                                <span class="nobr">Unrecognized Job Type: {{ type }}</span>
                            {% endif %}
                        </div>


                            

                    </div>
                </li>
            {% endfor %}
        </ul>

    <h3>New Job:</h3>

        <form id="jobForm">
            <section>
                <div class="formDiv">
                    <label for="jobName">Job Name:</label>
                    <input type="text" id="jobName" name="name" maxLength = "20" required>
                </div>
            <section>

            <br style="clear:both;" />

            <section>
                <div class="formDiv">
                    <label for="every" id="everyText">Every:</label>
                    <input type="quantity" id="everyInput" name="every" min="1" max="100" size="3" placeholder=1>
                </div>

                <div class="formDiv">
                    <label for="unit">Unit:</label>
                    <select id="unit" name="unit" required>
                    <option value="second">second</option>
                    <option value="minute">minute</option>
                    <option value="hour">hour</option>
                    <option value="day">day</option>
                    <option value="week">week</option>
                    <option value="monday">monday</option>
                    <option value="tuesday">tuesday</option>
                    <option value="wednesday">wednesday</option>
                    <option value="thursday">thursday</option>
                    <option value="friday">friday</option>
                    <option value="saturday">saturday</option>
                    <option value="sunday">sunday</option>
                    </select>
                </div>

                <div class="formDiv">
                    <label for="at" id="atText">At:</label>
                    <input type="number" class = "atInput" id="atHours" name="atHours" size="2" min="0" max="23" placeholder="HH">
                    <input type="number" class="atInput" id="atMinutes" name="atMinutes" size="2" min="0" max="59" placeholder="MM">
                    <input type="number" class="atInput" id="atSeconds" name="atSeconds" size="2" min="0" max="59" placeholder="SS">
                </div>
            </section>

            <br style="clear:both;" />

            <section>
                <div class="formDiv">
                    <label for="do">Do:</label>
                    <select id="do" name="do" required>
                    <option value="press">press</option>
                    </select>
                </div>

                <div class="formDiv">
                    <label for="pressChannel" id="pressChannelLabel">Channel:</label>
                    <input type="number" id="pressChannel" name="pressChannel" min={{ minChannel }} max= {{ maxChannel }} size="5" value="0">
                </div>

                <div class="formDiv">
                    <label for="pressValue" id="pressValueLabel">Value:</label>
                    <select id="pressValue" name="pressValue">
                    <option value="1">on</option>
                    <option value="">off</option>
                    </select>
                </div>
            </section>

            <br style="clear:both;" />

            <section>
                <div class="formDiv">
                    <button type="submit" class="greenButton">Create Job</button>
                </div>
            </section>

            <br style="clear:both;" />

        </form>
  </body>
</html>
